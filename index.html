<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Live GPS Tracker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    input, button {
      padding: 8px;
      margin: 5px 0;
      width: 100%;
    }
    .info {
      margin-top: 20px;
      background: #f0f0f0;
      padding: 15px;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <h2>üìç Live GPS Tracker</h2>

  <label>Destination Latitude:</label>
  <input type="number" step="any" id="destLat" placeholder="e.g., 12.9716" />

  <label>Destination Longitude:</label>
  <input type="number" step="any" id="destLng" placeholder="e.g., 77.5946" />

  <button onclick="startTracking()">Start Tracking</button>

  <div class="info" id="output">
    <p>Waiting for location...</p>
  </div>

  <script>
    let watchID, prevTimestamp = null, prevLat = null, prevLng = null;
    let destLat, destLng;
    const speedBuffer = [];
    let lastKnownETA = null;
    const SPEED_THRESHOLD = 2.77; // m/s = 10 km/h

    function toRad(deg) {
      return deg * Math.PI / 180;
    }

    function haversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const œÜ1 = toRad(lat1), œÜ2 = toRad(lat2);
      const ŒîœÜ = toRad(lat2 - lat1);
      const ŒîŒª = toRad(lon2 - lon1);

      const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

      return R * c; // in meters
    }

    function getAverageSpeed() {
      if (speedBuffer.length === 0) return 0;
      const sum = speedBuffer.reduce((a, b) => a + b, 0);
      return sum / speedBuffer.length;
    }

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}m ${secs}s`;
    }

    function startTracking() {
      destLat = parseFloat(document.getElementById('destLat').value);
      destLng = parseFloat(document.getElementById('destLng').value);

      if (isNaN(destLat) || isNaN(destLng)) {
        alert("Please enter valid destination coordinates.");
        return;
      }

      if ("geolocation" in navigator) {
        watchID = navigator.geolocation.watchPosition(successCallback, errorCallback, {
          enableHighAccuracy: true,
          maximumAge: 1000,
          timeout: 5000
        });
        document.getElementById('output').innerHTML = "<p>Tracking started...</p>";
      } else {
        alert("Geolocation is not supported by your browser.");
      }
    }

    function successCallback(position) {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      const timestamp = position.timestamp;

      let speed = position.coords.speed;

      // fallback speed calc if null
      if ((speed === null || speed < 0) && prevTimestamp && prevLat !== null) {
        const dist = haversineDistance(lat, lng, prevLat, prevLng);
        const time = (timestamp - prevTimestamp) / 1000;
        if (time > 0) speed = dist / time;
      }

      if (speed && speed > 0) {
        speedBuffer.push(speed);
        if (speedBuffer.length > 5) speedBuffer.shift();
      }

      const avgSpeed = getAverageSpeed();
      const distanceToDestMeters = haversineDistance(lat, lng, destLat, destLng);
      const distanceToDestKM = distanceToDestMeters / 1000;

      let etaText = "Calculating...";
      if (avgSpeed >= SPEED_THRESHOLD) {
        const timeLeft = distanceToDestMeters / avgSpeed;
        lastKnownETA = formatTime(timeLeft);
        etaText = lastKnownETA;
      } else if (lastKnownETA) {
        etaText = lastKnownETA + " (based on last good speed)";
      }

      const outputDiv = document.getElementById('output');
      outputDiv.innerHTML = `
        <h3>Live Location Data</h3>
        <p><strong>Latitude:</strong> ${lat.toFixed(6)}</p>
        <p><strong>Longitude:</strong> ${lng.toFixed(6)}</p>
        <p><strong>Average Speed:</strong> ${avgSpeed > 0 ? (avgSpeed * 3.6).toFixed(2) + ' km/h' : 'Stopped / No data'}</p>
        <p><strong>Distance to Destination:</strong> ${distanceToDestKM.toFixed(2)} km</p>
        <p><strong>Estimated Time Left:</strong> ${etaText}</p>
      `;

      prevTimestamp = timestamp;
      prevLat = lat;
      prevLng = lng;
    }

    function errorCallback(error) {
      document.getElementById('output').innerHTML = `<p>Error: ${error.message}</p>`;
    }
  </script>
</body>
</html>
